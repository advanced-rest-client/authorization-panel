<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-tabs/paper-tab.html">
<link rel="import" href="../vertical-tabs/vertical-tabs.html">
<link rel="import" href="../auth-methods/auth-methods.html">
<!--
`<authorization-panel>` The authorization panel used in the request panel.
It is a set of forms that allow set up the authorization method for a HTTP request.

It renders a set of forms. But it or it's children do not perform authorization.
In case of `basic` method the app should insert the authorization header automatically when
running the request.
When enabled authorization type is `ntlm` then username, password and domain should be passed
to transport (XHR, socket) and there perform the authorization.

Oauth 2 form sends the `oauth2-token-requested` with the OAuth settings provided with the form.
Any element / app can handle this event and perform authorization.
ARC provides the `<oauth2-authorization>` element (from the `oauth-authorization` repo) that can
be placed anywhere in the DOM (from current element where `authorization-panel` is attached up to
the body) and perform OAuth athorization. However it can be done by any other element / app  or
even server. See `<oauth2-authorization>` for detailed documentation.

Oauth 1a is not currently supported. Though the form is ready and available, there's no
authorization method in the ARC components set.

## Events
This element fires the `authorization-settings-changed` when any type of authorization
is enabled and valid data has been provided by the user.

This element also fires `authorization-type-enabled` and `authorization-type-disabled` events
when type state changes.
See demo for example usage.

### Example
```
<authorization-panel></authorization-panel>
```

### Styling
`<authorization-panel>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--authorization-panel` | Mixin applied to the element | `{}`

@group UI Elements
@element authorization-panel
@demo demo/index.html
-->
<dom-module id="authorization-panel">
  <template>
    <style>
    :host {
      display: block;
      @apply(--authorization-panel);
    }
    .content {
      @apply(--layout-horizontal);
      @apply(--layout-flex);
      position: relative;
    }

    vertical-tabs {
      width: 100%;
    }

    .enabled-marker {
      display: inline-block;
      width: 5px;
      height: 5px;
      margin-right: 12px;
      border-radius: 50%;
      background-color: transparent;
      transition: all 0.4s cubic-bezier(0, 0, 0.56, 1.04);
    }
    .enabled-marker[enabled] {
      background-color: var(--auth-enabled-marker-color, #48982A);
    }
    </style>
    <div class="content">
      <vertical-tabs selected="{{selected}}">
        <paper-tab data-type="basic"><span class="enabled-marker" enabled$="[[_isAuthEnabled('basic', enabledAuthType)]]"></span>BASIC</paper-tab>
        <paper-tab data-type="ntlm"><span class="enabled-marker" enabled$="[[_isAuthEnabled('ntlm', enabledAuthType)]]"></span>NTLM</paper-tab>
        <paper-tab data-type="oauth2"><span class="enabled-marker" enabled$="[[_isAuthEnabled('oauth2', enabledAuthType)]]"></span>OAUTH 2</paper-tab>
        <iron-pages content selected="{{selected}}">
          <auth-method-basic data-type="basic" raml-settings="[[_computeSettings(securedBy, 'Basic Authentication')]]"></auth-method-basic>
          <auth-method-ntlm data-type="ntlm" raml-settings="[[_computeSettings(securedBy, '???')]]"></auth-method-ntlm>
          <auth-method-oauth2 data-type="oauth2" redirect-url="[[redirectUrl]]" raml-settings="[[_computeSettings(securedBy, 'OAuth 2.0')]]"></auth-method-oauth2>
        </iron-pages>
      </vertical-tabs>
    </div>
  </template>
  <script>
  Polymer({
    is: 'authorization-panel',
    /**
     * Fired when auth type settings changed.
     * It will fire when any of types is enabled (or at the moment the it's disabling) and
     * any value of any property has changed.
     *
     * @event authorization-settings-changed
     * @param {Object} settings Current auth settings. It depends on enabled `type`.
     * @param {String} type Enabled auth type. For example `basic`, `ntlm` or `oauth2`.
     */
    /**
     * Fired when the authorization type has been enabled in the UI. Listen for
     * `authorization-settings-changed` event to get current auth settings.
     *
     * @event authorization-type-enabled
     * @param {String} type Enabled auth type
     */
    /**
     * Fired when the authorization type has been disabled in the UI.
     *
     * @event authorization-type-disabled
     * @param {String} type Disabled auth type
     */
    properties: {
      // Selected panel with auth method.
      selected: {
        type: Number,
        value: 0
      },
      // Currently enabled auth type. Can be one at the time.
      enabledAuthType: {
        type: String,
        notify: true
      },
      /**
       * Current settings of enabled auth type.
       * Can be `undefined` if the user hasn't filled all required fields in the form.
       */
      enabledSettings: {
        type: Object,
        readOnly: true,
        notify: true
      },
      /**
       * A definition of the RAML `securedBy` node of the method. description.
       * If set it will limit number of panels to show only those which are
       * defined in the RAML spec and provide the fill data.
       */
      securedBy: {
        type: Object,
        observer: '_securedByChanged'
      },
      /**
       * The OAuth2 redirect URL to be set in the OAuth2 form pane.
       */
      redirectUrl: String
    },

    observers: [
      '_enabledAuthTypeChanged(enabledAuthType)',
      '_authSettingsChanged(enabledSettings.*)'
    ],
    /**
     * Gets settings for clurrently enabled aoth method. Null if none is enabled.
     */
    get settings() {
      var current = this.enabledAuthType;
      if (!current) {
        return null;
      }
      var element = this.getElementForType(current);
      if (!element) {
        return null;
      }
      return element.settings;
    },

    listeners: {
      'authorization-enabled': '_onAuthEnabled',
      'authorization-disabled': '_onAuthDisabled',
      'auth-settings-changed': '_authSettingsHandler'
    },

    _enabledAuthTypeChanged: function() {
      var current = this.enabledAuthType;
      if (!current) {
        return this._setEnabledSettings(undefined);
      }
      var element = this.getElementForType(current);
      if (!element) {
        return this._setEnabledSettings(undefined);
      }

      if (element.validate !== undefined && !element.validate(true)) {
        return this._setEnabledSettings(undefined);
      }

      this._setEnabledSettings(element.settings);
    },

    _onAuthEnabled: function(e) {
      e = Polymer.dom(e);
      if (e.rootTarget === this) {
        return;
      }

      this._disableCurrentAuth();
      var type = this.getTypeForElement(e.rootTarget);
      if (!type) {
        throw new TypeError('Event source couldn\'t be recognized as an auth form.');
      }
      this.enabledAuthType = type;
      this.fire('authorization-type-enabled', {
        type: type
      });
    },

    _onAuthDisabled: function(e) {
      e = Polymer.dom(e);
      if (e.rootTarget === this) {
        return;
      }
      var type = this.getTypeForElement(e.rootTarget);

      if (this.enabledAuthType !== type) {
        return;
      }

      this.enabledAuthType = '';
      this._setEnabledSettings(undefined);
      this.fire('authorization-type-disabled', {
        type: type
      });
    },

    // Disable clurrently selected auth method.
    _disableCurrentAuth: function() {
      var current = this.enabledAuthType;
      if (!current) {
        return;
      }
      var target = this.getElementForType(current);
      if (!target) {
        return;
      }
      target.enabled = false;
      this.enabledAuthType = '';
      this._setEnabledSettings(undefined);
    },

    _isAuthEnabled: function(type, current) {
      return type === current;
    },
    /**
     * Returns an element that represent a form of a given type.
     *
     * @param {String} type Type of auth method. For example `oauth2`
     * @return {HTMLElement|null} A child element for given type or null if not found.
     */
    getElementForType: function(type) {
      switch (type) {
        case 'basic': return this.$$('auth-method-basic');
        case 'ntlm': return this.$$('auth-method-ntlm');
        case 'oauth2': return this.$$('auth-method-oauth2');
      }
      return null;
    },
    /**
     * Maps the (lower case) name of the element to the auth type.
     *
     * @param {String|HTMLElement} Lowercase name of the element of the element itself.
     * @return {String|null} Auth type name or null if the mapping is unknown.
     */
    getTypeForElement: function(element) {
      if (element instanceof HTMLElement) {
        element = element.nodeName.toLowerCase();
      }
      if (typeof element !== 'string') {
        throw new TypeError('Passed element is either string or HTMLElement');
      }
      switch (element) {
        case 'auth-method-basic': return 'basic';
        case 'auth-method-ntlm': return 'ntlm';
        case 'auth-method-oauth2': return 'oauth2';
      }
      return null;
    },

    _authSettingsHandler: function(e, detail) {
      if (!this.enabledAuthType) {
        this._setEnabledSettings(undefined);
        return;
      }

      e = Polymer.dom(e);
      var type = this.getTypeForElement(e.rootTarget);
      if (!type) {
        throw new TypeError('Event source couldn\'t be recognized as an auth form.');
      }

      if (type !== this.enabledAuthType) {
        // Only for currently enabled type
        return;
      }
      this._setEnabledSettings(detail);
    },
    // Fires the `authorization-settings-changed` event when something change
    _authSettingsChanged: function() {
      this.fire('authorization-settings-changed', {
        settings: this.enabledSettings,
        type: this.enabledAuthType
      });
    },
    /**
     * A handler called when the `securedBy` property changes.
     * It sets up the tabs by hidding the ones not defined in the
     * RAML spec.
     */
    _securedByChanged: function(secured) {
      var state = {
        oauth1: false,
        oauth2: false,
        basic: false,
        ntlm: false,
      };
      if (!secured || !secured.length) {
        // If no RAML then show all.
        for (var _key in state) {
          state[_key] = true;
        }
        return this._updateTabs(state);
      }
      secured.forEach(function(data) {
        switch (data.type) {
          case 'OAuth 1.0': state.oauth1 = true; break;
          case 'OAuth 2.0': state.oauth2 = true; break;
          case 'Basic Authentication': state.basic = true; break;
          case 'Digest Authentication': break;
          case 'Pass Through': break;
          default:
            console.warn('Unsupported auth method', data);
        }
      });
      this._updateTabs(state);
    },
    /**
     * Updates tabs visibility when RAML definition change.
     *
     * @param {Object} state A map where keys are auth types and values is
     * the boolean value of the state. True for show the tab.
     */
    _updateTabs: function(state) {
      if (!state) {
        return;
      }
      var _selectedKey;
      var supported = ['basic','ntlm','oauth2'];
      for (var _key in state) {
        var nodes = Polymer.dom(this.root).querySelectorAll('[data-type="' +
          _key + '"]');
        if (!nodes) {
          continue;
        }
        var _state = state[_key];
        if (_state && !_selectedKey && supported.indexOf(_key) !== -1) {
          _selectedKey = _key;
        }
        for (var i = 0, len = nodes.length; i < len; i++) {
          if (!_state && !nodes[i].hasAttribute('hidden')) {
            nodes[i].setAttribute('hidden', true);
          } else if (_state && nodes[i].hasAttribute('hidden')) {
            nodes[i].removeAttribute('hidden');
          }
        }
      }
      var tabs = this.$$('vertical-tabs');
      tabs.notifyResize();
      if (_selectedKey) {
        switch (_selectedKey) {
          case 'basic': this.selected = 0; break;
          case 'ntlm': this.selected = 1; break;
          case 'oauth2': this.selected = 2; break;
        }
      }
    },
    /**
     * Computes settings for the auth panel if RAML's `securedBy`
     * property is set and the `type` matches one of the defined types.
     *
     * @param {Array} secured The `securedBy` value.
     * @param {String} type RAML's one of predefined authorization types.
     * @return {Object|undefined} A scheme definition object if `type` matches.
     */
    _computeSettings: function(secured, type) {
      if (!secured || !secured.length || !type) {
        return undefined;
      }
      for (var i = 0, len = secured.length; i < len; i++) {
        if (secured[i].type === type) {
          return secured[i];
        }
      }
    }
  });
  </script>
</dom-module>
